<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppMeeting - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f8fafc; }
        .hidden-section { display: none !important; }
        .nav-btn.active { background-color: #eff6ff; color: #4f46e5; border-right: 4px solid #4f46e5; font-weight: 600; }
        .equip input:checked + div {
            background: #eef2ff; border-color: #6366f1; color: #4338ca; font-weight: 600;
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #bookingModal, #sidebar { z-index: 50; }
        
        /* Mobile Overlay */
        @media (max-width: 1024px) {
            #sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
        }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: white; padding: 16px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 5px solid;
            min-width: 300px; transform: translateX(100%); transition: transform 0.3s ease-out;
            display: flex; align-items: center; gap: 12px;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { border-color: #10b981; }
        .toast-error { border-color: #ef4444; }
        .toast-info { border-color: #3b82f6; }
        .toast-warning { border-color: #f59e0b; } /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ */
    </style>
</head>
<body class="h-screen overflow-hidden text-gray-700 bg-gray-50">
    <script>
        // *** ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å URL ***
        const API_BASE_URL = 'http://localhost:3000/api'; 
    </script>
    
    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- AUTH SCREEN -->
    <div id="authSection" class="h-full flex items-center justify-center bg-slate-900 relative overflow-hidden">
        <div class="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center"></div>
        
        <!-- Login Form -->
        <div id="loginCard" class="bg-white/95 backdrop-blur p-8 rounded-3xl shadow-2xl w-full max-w-sm relative z-10 mx-4 fade-in">
            <h2 class="text-3xl font-bold text-center mb-2 text-indigo-700">AppMeeting</h2>
            <p class="text-center text-gray-400 text-sm mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">USERNAME</label>
                    <input id="lUser" class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white outline-none focus:ring-2 ring-indigo-500 transition" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">PASSWORD</label>
                    <input id="lPass" type="password" class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white outline-none focus:ring-2 ring-indigo-500 transition" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                </div>
                <div class="text-right">
                    <a href="javascript:void(0)" onclick="toggleAuth('forgot')" class="text-xs text-indigo-500 hover:underline">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg transform active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
             <p class="text-center mt-6 text-sm text-gray-500">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="javascript:void(0)" onclick="toggleAuth('register')" class="text-indigo-600 font-bold hover:underline">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
            </p>
        </div>

        <!-- Register Form -->
        <div id="registerCard" class="hidden-section bg-white/95 backdrop-blur p-8 rounded-3xl shadow-2xl w-full max-w-md relative z-10 mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-12 h-12 bg-emerald-600 rounded-2xl shadow-lg mb-2 text-white text-xl">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h2 class="text-2xl font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</h2>
                <p class="text-gray-400 text-sm">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            </div>
            <form onsubmit="handleRegister(event)" class="space-y-3">
                <input id="rFullname" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required class="w-full p-3 bg-gray-50 rounded-xl border outline-none focus:ring-2 ring-emerald-500">
                <input id="rUser" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username)" required class="w-full p-3 bg-gray-50 rounded-xl border outline-none focus:ring-2 ring-emerald-500">
                <input id="rEmail" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)" required class="w-full p-3 bg-gray-50 rounded-xl border outline-none focus:ring-2 ring-emerald-500">
                <input id="rPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required class="w-full p-3 bg-gray-50 rounded-xl border outline-none focus:ring-2 ring-emerald-500">
                <button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </form>
            <p class="text-center mt-4 text-sm text-gray-500">
                ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? <a href="javascript:void(0)" onclick="toggleAuth('login')" class="text-indigo-600 font-bold hover:underline">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
            </p>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgotCard" class="hidden-section bg-white/95 backdrop-blur p-8 rounded-3xl shadow-2xl w-full max-w-sm relative z-10 mx-4 fade-in">
            <h2 class="text-2xl font-bold text-center mb-2 text-indigo-700">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
            <p class="text-center text-gray-400 text-sm mb-6">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
            
            <div id="forgotStep1">
                <form onsubmit="handleForgotCheck(event)" class="space-y-4">
                    <input id="fUser" class="w-full p-3 border rounded-xl bg-gray-50 outline-none focus:ring-2 ring-indigo-500" placeholder="Username" required>
                    <input id="fEmail" type="email" class="w-full p-3 border rounded-xl bg-gray-50 outline-none focus:ring-2 ring-indigo-500" placeholder="Email ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </form>
            </div>

            <div id="forgotStep2" class="hidden">
                <form onsubmit="handleResetPassword(event)" class="space-y-4">
                    <input id="fNewPass" type="password" class="w-full p-3 border rounded-xl bg-gray-50 outline-none focus:ring-2 ring-indigo-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" required>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
                </form>
            </div>

            <p class="text-center mt-6 text-sm text-gray-500">
                <a href="javascript:void(0)" onclick="toggleAuth('login')" class="text-indigo-600 font-bold hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
            </p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appSection" class="hidden-section flex h-full relative">
        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>

        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-xl flex flex-col border-r border-gray-100 transition-transform duration-300" id="sidebar">
            <div class="p-6 border-b flex justify-between items-center">
                <h1 class="font-bold text-xl text-indigo-600 tracking-tight">AppMeeting</h1>
                <span class="text-[10px] bg-green-50 text-green-600 px-2 py-1 rounded border border-green-100">Online</span>
            </div>
            
            <div class="p-6 text-center border-b bg-gradient-to-b from-white to-slate-50">
                <div class="relative inline-block">
                    <img id="sideAvatar" src="" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover border-4 border-white shadow-md cursor-pointer hover:opacity-80 transition" onclick="renderPage('profile')">
                    <div id="statusDot" class="absolute bottom-2 right-0 w-5 h-5 bg-green-500 border-4 border-white rounded-full"></div>
                </div>
                <h3 id="sideName" class="font-bold text-gray-800 text-lg leading-tight truncate px-2">...</h3>
                <span id="sideRole" class="text-xs font-bold mt-1 inline-block px-3 py-1 rounded-full text-white bg-gray-400">...</span>
                <button onclick="renderPage('profile')" class="block mx-auto mt-2 text-xs text-indigo-500 hover:underline"><i class="fas fa-cog"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <p class="px-3 text-[10px] font-bold text-gray-400 uppercase mb-2 mt-2">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</p>
                <button onclick="renderPage('home')" class="nav-btn active w-full text-left p-3 rounded-xl hover:bg-indigo-50 flex gap-3 transition items-center text-sm" data-page="home">
                    <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center"><i class="fas fa-home"></i></div>
                    ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </button>
                <button onclick="renderPage('calendar')" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-indigo-50 flex gap-3 transition items-center text-sm" data-page="calendar">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-calendar-alt"></i></div>
                    ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≠‡∏á
                </button>
                <button onclick="openBookingModal()" class="w-full text-left p-3 rounded-xl hover:bg-indigo-50 flex gap-3 transition items-center text-sm group">
                    <div class="w-8 h-8 rounded-lg bg-indigo-600 text-white flex items-center justify-center shadow-md group-hover:scale-110 transition"><i class="fas fa-plus"></i></div>
                    <span class="font-bold text-indigo-700">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</span>
                </button>
                <button onclick="renderPage('history')" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-indigo-50 flex gap-3 transition items-center text-sm" data-page="history">
                    <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fas fa-history"></i></div>
                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
                
                <!-- Admin Menu -->
                <div id="adminMenu" class="hidden-section mt-6 pt-4 border-t border-dashed">
                    <p class="px-3 text-[10px] font-bold text-gray-400 uppercase mb-2">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <button onclick="renderPage('approve')" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-orange-50 text-orange-600 flex gap-3 items-center text-sm" data-page="approve">
                        <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fas fa-tasks"></i></div>
                        ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á <span id="badgePending" class="hidden ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button onclick="renderPage('rooms')" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-teal-50 text-teal-600 flex gap-3 items-center text-sm" data-page="rooms">
                        <div class="w-8 h-8 rounded-lg bg-teal-100 text-teal-600 flex items-center justify-center"><i class="fas fa-door-open"></i></div>
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á
                    </button>
                    <button onclick="renderPage('users')" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-pink-50 text-pink-600 flex gap-3 items-center text-sm" data-page="users">
                        <div class="w-8 h-8 rounded-lg bg-pink-100 text-pink-600 flex items-center justify-center"><i class="fas fa-users-cog"></i></div>
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                    </button>
                </div>
            </nav>
            <div class="p-4 border-t bg-gray-50">
                <button onclick="logout()" class="w-full text-gray-500 hover:text-red-500 hover:bg-red-50 p-2 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
            <header class="h-16 bg-white border-b px-6 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 text-gray-600"><i class="fas fa-bars text-xl"></i></button>
                    <h2 id="pageTitle" class="text-xl font-bold text-gray-800">Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden md:block">
                        <p id="dateDisplay" class="text-sm font-bold text-gray-700"></p>
                        <p id="timeDisplay" class="text-xs text-gray-500"></p>
                    </div>
                </div>
            </header>
            
            <div id="contentArea" class="flex-1 p-6 md:p-8 overflow-y-auto pb-20 scroll-smooth">
                <!-- Content Injected Here -->
            </div>
        </main>
    </div>

    <!-- BOOKING MODAL -->
    <div id="bookingModal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl h-[90vh] md:h-[85vh] rounded-3xl shadow-2xl flex flex-col md:flex-row overflow-hidden fade-in">
            <!-- Left: Form -->
            <div class="w-full md:w-1/3 bg-slate-50 p-6 md:p-8 border-r overflow-y-auto flex flex-col">
                <h3 class="text-xl font-bold mb-1 text-gray-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
                <p class="text-xs text-gray-400 mb-6">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</p>
                
                <div class="space-y-4 flex-1">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° <span class="text-red-500">*</span></label>
                        <input id="bkTopic" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô..." class="w-full p-3 border rounded-xl focus:ring-2 ring-indigo-500 outline-none bg-white">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</label>
                        <input id="bkPeople" type="number" min="1" value="5" class="w-full p-3 border rounded-xl outline-none bg-white">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° <span class="text-red-500">*</span></label>
                        <input id="bkStart" type="datetime-local" class="w-full p-3 border rounded-xl outline-none bg-white">
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-2">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="equip"><input type="checkbox" value="WiFi" checked hidden><div class="p-2 border rounded-lg text-center cursor-pointer text-xs hover:bg-gray-100 transition"><i class="fas fa-wifi mr-1"></i> WiFi</div></label>
                            <label class="equip"><input type="checkbox" value="Projector" hidden><div class="p-2 border rounded-lg text-center cursor-pointer text-xs hover:bg-gray-100 transition"><i class="fas fa-video mr-1"></i> Projector</div></label>
                            <label class="equip"><input type="checkbox" value="Whiteboard" hidden><div class="p-2 border rounded-lg text-center cursor-pointer text-xs hover:bg-gray-100 transition"><i class="fas fa-chalkboard mr-1"></i> Board</div></label>
                            <label class="equip"><input type="checkbox" value="Snack" hidden><div class="p-2 border rounded-lg text-center cursor-pointer text-xs hover:bg-gray-100 transition"><i class="fas fa-cookie-bite mr-1"></i> Snack</div></label>
                        </div>
                    </div>
                </div>
                
                <div class="pt-4 mt-4 border-t">
                    <button onclick="closeModal()" class="w-full py-2 text-gray-400 text-sm font-bold hover:text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
            
            <!-- Right: Room Select -->
            <div class="w-full md:w-2/3 bg-white p-6 md:p-8 flex flex-col relative">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-bold text-gray-700 text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full"><i class="fas fa-check-circle mr-1"></i>‡πÅ‡∏™‡∏î‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</span>
                </div>
                <div id="roomList" class="flex-1 overflow-y-auto space-y-3 pr-2 pb-20">
                    <p class="text-center text-gray-400 mt-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script>
        let currentUser = null;
        let allRooms = [];
        let allBookings = [];
        let allUsers = [];
        let forgotUserId = null;
        let currentPage = 'home';
        let isFirstLoad = true;
        let lastBookingState = {}; 
        let notifiedBookings = new Set(); // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß

        const $ = id => document.getElementById(id);

        window.onload = async () => {
            const savedUser = localStorage.getItem('am_token_user');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                await loadData();
                initUI();
                
                // *** AUTO REFRESH & NOTIFICATIONS ***
                setInterval(async () => {
                    await loadData();
                    updateBadge();
                    if(currentPage === 'approve') renderApprove();
                    else if(currentPage === 'home') renderDashboard();
                }, 3000); 

                // *** REMINDER CHECK EVERY 1 MINUTE ***
                setInterval(checkUpcomingMeetings, 60000);
            }
            updateClock();
            setInterval(updateClock, 60000);
        };

        async function loadData() {
            try {
                if(!currentUser) return;
                
                const resRooms = await fetch(`${API_BASE_URL}/admin/rooms`);
                allRooms = await resRooms.json();

                const resBookings = await fetch(`${API_BASE_URL}/bookings`);
                allBookings = await resBookings.json();

                if(currentUser.role === 'admin') {
                    const resUsers = await fetch(`${API_BASE_URL}/admin/users`);
                    allUsers = await resUsers.json();
                }

                // *** STATUS CHANGE NOTIFICATION ***
                const currentBookingState = {};
                allBookings.forEach(b => {
                    currentBookingState[b.id] = b.status;
                    
                    if (!isFirstLoad) {
                        if (!lastBookingState[b.id]) {
                            if (currentUser.role === 'admin' && b.status === 'pending') {
                                showToast(`üîî ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà: ${b.topic}`, 'info');
                            }
                        } else if (lastBookingState[b.id] !== b.status) {
                             if (currentUser.id === b.user_id) {
                                 if (b.status === 'approved') showToast(`‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á "${b.topic}" ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                                 if (b.status === 'rejected') showToast(`‚ùå ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á "${b.topic}" ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`, 'error');
                             }
                        }
                    }
                });
                
                lastBookingState = currentBookingState;
                isFirstLoad = false;
                
                // Call reminder check initially too
                checkUpcomingMeetings();

            } catch (error) { console.error("Error loading data:", error); }
        }

        // *** MEETING REMINDER LOGIC ***
        function checkUpcomingMeetings() {
            if (!currentUser) return;
            
            const now = new Date();
            // Filter only approved meetings for current user
            const myBookings = allBookings.filter(b => 
                b.user_id === currentUser.id && 
                b.status === 'approved'
            );

            myBookings.forEach(b => {
                const start = new Date(b.start_time);
                const diffMs = start - now;
                const diffMins = Math.floor(diffMs / 60000);

                // Check if already notified to avoid spam
                if (notifiedBookings.has(b.id + '_' + diffMins)) return; // Simple key to allow notify at 15 then 5 etc if needed, or just block b.id globally for one-time

                // Alert at 15 mins, 10 mins, 5 mins (approx)
                // Using range to capture it even if interval is slightly off
                if (diffMins === 15 || diffMins === 10 || diffMins === 5) {
                    showToast(`‚è∞ ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° "${b.topic}" ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ`, 'warning');
                    notifiedBookings.add(b.id + '_' + diffMins); // Mark as notified for this specific time
                } 
                // Immediate start
                else if (diffMins === 0) {
                     if (!notifiedBookings.has(b.id + '_0')) {
                        showToast(`üî¥ ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° "${b.topic}" ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!`, 'warning');
                        notifiedBookings.add(b.id + '_0');
                     }
                }
            });
        }

        // --- TOAST FUNCTION ---
        function showToast(message, type = 'info') {
            const container = $('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = 'fa-info-circle text-blue-500';
            if(type === 'success') icon = 'fa-check-circle text-green-500';
            if(type === 'error') icon = 'fa-times-circle text-red-500';
            if(type === 'warning') icon = 'fa-clock text-yellow-500';

            toast.innerHTML = `
                <i class="fas ${icon} text-xl"></i>
                <div>
                    <p class="font-bold text-sm text-gray-800">${type === 'error' ? '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : (type === 'warning' ? '‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤' : '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')}</p>
                    <p class="text-xs text-gray-500">${message}</p>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000); // 5 seconds
        }

        function updateClock() {
            const now = new Date();
            if($('dateDisplay')) $('dateDisplay').innerText = now.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
            if($('timeDisplay')) $('timeDisplay').innerText = now.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' });
        }

        // --- AUTH ---
        function toggleAuth(mode) {
            $('loginCard').classList.add('hidden-section');
            $('registerCard').classList.add('hidden-section');
            $('forgotCard').classList.add('hidden-section');

            if(mode === 'register') $('registerCard').classList.remove('hidden-section');
            else if(mode === 'forgot') {
                $('forgotCard').classList.remove('hidden-section');
                $('forgotStep1').classList.remove('hidden');
                $('forgotStep2').classList.add('hidden');
            }
            else $('loginCard').classList.remove('hidden-section');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const u = $('lUser').value.trim(), p = $('lPass').value.trim();
            try {
                const res = await fetch(`${API_BASE_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
                const data = await res.json();
                if(data.success) {
                    currentUser = data.user;
                    if(!currentUser.avatar || currentUser.avatar === 'default.png') currentUser.avatar = `https://ui-avatars.com/api/?name=${currentUser.fullname}&background=random&color=fff`;
                    else currentUser.avatar = `${API_BASE_URL.replace('/api','')}/uploads/${currentUser.avatar}`;
                    
                    localStorage.setItem('am_token_user', JSON.stringify(currentUser));
                    location.reload(); 
                } else alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.message);
            } catch (err) { alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const fullname=$('rFullname').value, username=$('rUser').value, password=$('rPass').value, email=$('rEmail').value;
            try {
                const res = await fetch(`${API_BASE_URL}/register`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({fullname,username,password,email})});
                if((await res.json()).success) { alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); toggleAuth('login'); }
                else alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function handleForgotCheck(e) {
            e.preventDefault();
            const username = $('fUser').value, email = $('fEmail').value;
            const res = await fetch(`${API_BASE_URL}/forgot-password`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username,email})});
            const data = await res.json();
            if(data.success) {
                forgotUserId = data.userId;
                $('forgotStep1').classList.add('hidden');
                $('forgotStep2').classList.remove('hidden');
            } else alert(data.message);
        }

        async function handleResetPassword(e) {
            e.preventDefault();
            const newPassword = $('fNewPass').value;
            const res = await fetch(`${API_BASE_URL}/reset-password`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({userId: forgotUserId, newPassword})});
            if((await res.json()).success) { alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); toggleAuth('login'); }
            else alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function logout() { localStorage.removeItem('am_token_user'); location.reload(); }

        // --- UI RENDER ---
        function initUI() {
            $('authSection').classList.add('hidden-section');
            $('appSection').classList.remove('hidden-section');
            $('sideName').innerText = currentUser.fullname;
            $('sideAvatar').src = currentUser.avatar;
            
            const roleEl = $('sideRole');
            if(currentUser.role === 'admin') {
                roleEl.innerText = '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
                roleEl.className = 'text-xs font-bold mt-1 inline-block px-3 py-1 rounded-full text-white bg-indigo-600 shadow-indigo-200 shadow-lg';
                $('adminMenu').classList.remove('hidden-section');
            } else {
                roleEl.innerText = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                roleEl.className = 'text-xs font-bold mt-1 inline-block px-3 py-1 rounded-full text-white bg-gray-400';
            }
            updateBadge();
            renderPage('home');
            
            $('sidebarOverlay').classList.add('hidden');
            $('sidebar').classList.remove('open');
        }

        function updateBadge() {
            if(currentUser.role !== 'admin') return;
            const pendings = allBookings.filter(b => b.status === 'pending').length;
            const badge = $('badgePending');
            badge.innerText = pendings;
            if(pendings > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
        }

        async function renderPage(page) {
            currentPage = page;

            if(currentUser.role !== 'admin' && ['approve', 'rooms', 'users'].includes(page)) {
                alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
                return;
            }

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.dataset.page === page) btn.classList.add('active');
            });

            toggleSidebar(false);

            const content = $('contentArea');
            $('pageTitle').innerText = 
                page === 'home' ? '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (Overview)' :
                page === 'calendar' ? '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á' :
                page === 'history' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô' :
                page === 'profile' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' :
                page === 'approve' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (Admin)' :
                page === 'rooms' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°' : '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';

            if(page === 'home') renderDashboard();
            else if(page === 'calendar') renderCalendarPage();
            else if(page === 'history') renderHistory();
            else if(page === 'profile') renderProfile();
            else if(page === 'approve') renderApprove();
            else if(page === 'rooms') renderRooms();
            else if(page === 'users') renderUsers();
        }

        // --- PAGE FUNCTIONS ---
        function renderDashboard() {
            const myBookings = allBookings.filter(b => b.user_id === currentUser.id);
            const now = new Date();
            const nextMeeting = myBookings
                .filter(b => b.status === 'approved' && new Date(b.start_time) > now)
                .sort((a, b) => new Date(a.start_time) - new Date(b.start_time))[0];
            
            let pendingCount = 0;
            if (currentUser.role === 'admin') {
                pendingCount = allBookings.filter(b => b.status === 'pending').length;
            }

            let html = `<div class="fade-in max-w-6xl mx-auto space-y-6">`;
            
            html += `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-gradient-to-r from-indigo-600 to-blue-600 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden">
                        <div class="relative z-10">
                            <h2 class="text-2xl md:text-3xl font-bold mb-2">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡∏Ñ‡∏∏‡∏ì${currentUser.fullname.split(' ')[0]} üëã</h2>
                            <p class="text-indigo-100 mb-6">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                            ${nextMeeting ? `
                                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 md:p-6 border border-white/20">
                                    <div class="flex items-center gap-3 mb-2 text-indigo-200 text-xs font-bold uppercase tracking-wider">
                                        <i class="fas fa-calendar-day"></i> ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                                    </div>
                                    <h3 class="text-xl md:text-2xl font-bold mb-2 truncate">${nextMeeting.topic}</h3>
                                    <div class="flex flex-wrap gap-4 text-sm">
                                        <span class="flex items-center gap-2"><i class="far fa-clock"></i> ${formatDateTime(nextMeeting.start_time)}</span>
                                        <span class="flex items-center gap-2"><i class="fas fa-map-marker-alt"></i> ${nextMeeting.room_name}</span>
                                    </div>
                                </div>
                            ` : `<div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 flex items-center gap-4"><div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-xl">‚òï</div><div><h3 class="font-bold text-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</h3></div></div>`}
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 flex flex-col justify-center">
                        <h4 class="font-bold text-gray-700 mb-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-xl">
                                <span class="font-bold text-gray-800">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
                                <span class="font-bold text-green-600">${myBookings.filter(b=>b.status==='approved').length}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-orange-50 rounded-xl">
                                <span class="font-bold text-gray-800">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                <span class="font-bold text-orange-600">${myBookings.filter(b=>b.status==='pending').length}</span>
                            </div>
                            ${currentUser.role === 'admin' ? `
                            <div class="p-3 bg-slate-900 text-white rounded-xl text-center cursor-pointer hover:bg-slate-800 transition shadow-lg" onclick="renderPage('approve')">
                                <p class="text-xs text-gray-400">ADMIN ONLY</p>
                                <p class="font-bold">‡∏£‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <span class="text-yellow-400 text-lg mx-1">${pendingCount}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            </div>` : ''}
                        </div>
                    </div>
                </div>`;

            html += `
                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                        <button onclick="renderPage('history')" class="text-sm text-indigo-600 hover:underline">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                                <tr>
                                    <th class="p-4 pl-6">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                    <th class="p-4">‡∏´‡πâ‡∏≠‡∏á</th>
                                    <th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${myBookings.length > 0 ? myBookings.slice(0, 5).reverse().map(b => `
                                    <tr class="hover:bg-slate-50 transition">
                                        <td class="p-4 pl-6 font-bold text-gray-700">${b.topic}</td>
                                        <td class="p-4 text-gray-600">${b.room_name || 'N/A'}</td>
                                        <td class="p-4 text-gray-500 text-xs">${formatDateTime(b.start_time)}</td>
                                        <td class="p-4 text-center">${getStatusBadge(b.status)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="4" class="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            $('contentArea').innerHTML = html;
        }

        function renderProfile() {
            let html = `
                <div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-sm border p-8 fade-in">
                    <div class="text-center mb-8">
                        <div class="relative inline-block group">
                            <img src="${currentUser.avatar}" class="w-24 h-24 rounded-full border-4 border-white shadow-lg object-cover">
                            <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" onclick="$('pAvatar').click()">
                                <i class="fas fa-camera text-white"></i>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mt-4">${currentUser.fullname}</h3>
                        <p class="text-gray-500">${currentUser.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•'}</p>
                    </div>

                    <form onsubmit="handleProfileUpdate(event)" class="space-y-4">
                        <input type="file" id="pAvatar" class="hidden" accept="image/*" onchange="previewAvatar(this)">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                <input id="pFullname" value="${currentUser.fullname}" class="w-full p-3 border rounded-xl bg-gray-50 outline-none focus:ring-2 ring-indigo-500" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <input id="pEmail" value="${currentUser.email || ''}" class="w-full p-3 border rounded-xl bg-gray-50 outline-none focus:ring-2 ring-indigo-500" required>
                            </div>
                        </div>

                        <div>
                             <label class="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
                             <input id="pPass" type="password" class="w-full p-3 border rounded-xl bg-gray-50 outline-none focus:ring-2 ring-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        
                        <div class="pt-4 flex justify-end gap-3">
                            <button type="button" onclick="renderPage('home')" class="px-6 py-2 text-gray-500 hover:bg-gray-100 rounded-xl font-bold transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </form>
                </div>
            `;
            $('contentArea').innerHTML = html;
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const fullname = $('pFullname').value;
            const email = $('pEmail').value;
            const password = $('pPass').value;
            const avatarFile = $('pAvatar').files[0];

            const formData = new FormData();
            formData.append('id', currentUser.id);
            formData.append('fullname', fullname);
            formData.append('email', email);
            if(password) formData.append('password', password);
            if(avatarFile) formData.append('avatar', avatarFile);

            try {
                const res = await fetch(`${API_BASE_URL}/profile`, { method: 'PUT', body: formData });
                const data = await res.json();
                if(data.success) {
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    currentUser = data.user;
                    if(!currentUser.avatar.startsWith('http')) {
                        if(currentUser.avatar === 'default.png') currentUser.avatar = `https://ui-avatars.com/api/?name=${currentUser.fullname}`;
                        else currentUser.avatar = `${API_BASE_URL.replace('/api','')}/uploads/${currentUser.avatar}`;
                    }
                    localStorage.setItem('am_token_user', JSON.stringify(currentUser));
                    initUI();
                } else showToast(data.message, 'error');
            } catch(e) { showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
        }

        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.querySelector('.group img').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderCalendarPage() {
            $('contentArea').innerHTML = `<div class="bg-white p-4 rounded-3xl shadow-sm border h-[600px] fade-in"><div id="calendar" class="h-full"></div></div>`;
            
            let eventsData = allBookings;
            if (currentUser.role !== 'admin') {
                eventsData = allBookings.filter(b => b.user_id === currentUser.id);
            }

            const events = eventsData.map(b => ({
                title: `${b.topic} (${b.room_name})`,
                start: b.start_time,
                end: b.end_time,
                backgroundColor: b.status === 'approved' ? (b.user_id === currentUser.id ? '#4f46e5' : '#10b981') : b.status === 'pending' ? '#f59e0b' : '#ef4444',
                borderColor: 'transparent',
                extendedProps: { status: b.status, user: b.fullname }
            }));
            
            setTimeout(() => {
                const calendar = new FullCalendar.Calendar($('calendar'), {
                    initialView: window.innerWidth < 768 ? 'timeGridDay' : 'timeGridWeek',
                    locale: 'th',
                    headerToolbar: { left: 'prev,next', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                    events: events,
                    height: '100%',
                    slotMinTime: '08:00:00',
                    slotMaxTime: '19:00:00'
                });
                calendar.render();
            }, 100);
        }

        function renderApprove() {
            const bookings = allBookings.filter(b => b.status === 'pending');
            if(bookings.length === 0) {
                $('contentArea').innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 fade-in"><i class="fas fa-check-circle text-6xl mb-4 text-green-100"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p></div>`;
                return;
            }
            let html = `<h3 class="font-bold text-xl mb-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (${bookings.length})</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in">`;
            html += bookings.map(b => `
                <div class="bg-white rounded-2xl shadow-sm border p-6 flex flex-col relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-orange-400"></div>
                    <div class="mb-4"><p class="text-sm font-bold text-gray-800">${b.fullname}</p></div>
                    <div class="bg-gray-50 rounded-xl p-4 mb-4 text-sm space-y-2">
                        <p class="font-bold text-indigo-600 text-lg">${b.topic}</p>
                        <p class="flex items-center gap-2 text-gray-600"><i class="fas fa-door-open w-5 text-center"></i> ${b.room_name}</p>
                        <p class="flex items-center gap-2 text-gray-600"><i class="far fa-clock w-5 text-center"></i> ${formatDateTime(b.start_time)}</p>
                        <p class="flex items-center gap-2 text-gray-600 text-xs"><i class="fas fa-tools w-5 text-center"></i> ${b.equipment || '-'}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-auto">
                        <button onclick="updateBooking(${b.id}, 'approved')" class="bg-green-500 hover:bg-green-600 text-white py-2 rounded-xl font-bold shadow transition">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button onclick="updateBooking(${b.id}, 'rejected')" class="bg-white border border-red-200 text-red-500 hover:bg-red-50 py-2 rounded-xl font-bold transition">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    </div>
                </div>`).join('');
            html += `</div>`;
            $('contentArea').innerHTML = html;
        }

        function renderRooms() {
            let html = `
                <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3><button onclick="addNewRoom()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow hover:bg-indigo-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in">`;
            html += allRooms.map(r => `
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden group">
                    <div class="h-32 bg-gray-200 flex items-center justify-center text-white text-4xl relative">
                        <i class="fas fa-door-open opacity-50"></i>
                        <button onclick="deleteRoom(${r.id})" class="absolute top-2 right-2 bg-white/20 hover:bg-red-500 text-white p-2 rounded-lg backdrop-blur transition"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="p-5"><h4 class="font-bold text-lg text-gray-800">${r.name}</h4><div class="flex items-center gap-2 text-sm text-gray-500 mt-1"><span>${r.capacity} ‡∏Ñ‡∏ô</span></div></div>
                </div>`).join('');
            html += `</div>`;
            $('contentArea').innerHTML = html;
        }

        function renderUsers() {
            let html = `
                <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3></div>
                <div class="bg-white rounded-3xl shadow-sm border overflow-hidden fade-in">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                                <tr>
                                    <th class="p-4 pl-6">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                                    <th class="p-4">Role</th>
                                    <th class="p-4">Username</th>
                                    <th class="p-4 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${allUsers.map(u => `
                                    <tr class="hover:bg-slate-50">
                                        <td class="p-4 pl-6 font-bold text-gray-700">${u.fullname}</td>
                                        <td class="p-4"><span class="${u.role==='admin'?'bg-purple-100 text-purple-700':'bg-gray-100'} px-2 py-1 rounded-full text-xs font-bold uppercase">${u.role}</span></td>
                                        <td class="p-4 text-gray-500">${u.username}</td>
                                        <td class="p-4 text-right">
                                            ${u.id !== currentUser.id ? `<button onclick="deleteUser(${u.id})" class="text-red-400 hover:bg-red-50 p-2 rounded-lg transition"><i class="fas fa-trash"></i></button>` : '<span class="text-gray-300 text-xs">Me</span>'}
                                        </td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            $('contentArea').innerHTML = html;
        }

        function renderHistory() {
            const bookings = allBookings.filter(b => b.user_id === currentUser.id).sort((a,b) => new Date(b.start_time) - new Date(a.start_time));
            let html = `
                <div class="bg-white rounded-3xl shadow-sm border p-6 fade-in"><h3 class="font-bold text-lg mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs"><tr><th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="p-4">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th class="p-4">‡∏´‡πâ‡∏≠‡∏á</th><th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-4">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th class="p-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody class="divide-y divide-gray-100">
                                ${bookings.map(b => `
                                    <tr class="hover:bg-slate-50">
                                        <td class="p-4">${new Date(b.start_time).toLocaleDateString('th-TH')}</td>
                                        <td class="p-4">${formatTime(b.start_time)} - ${formatTime(b.end_time)}</td>
                                        <td class="p-4 font-bold text-gray-700">${b.topic}</td>
                                        <td class="p-4">${b.room_name}</td>
                                        <td class="p-4">${getStatusBadge(b.status)}</td>
                                        <td class="p-4 text-xs text-gray-500">${b.equipment || '-'}</td>
                                        <td class="p-4">${b.status === 'pending' ? `<button onclick="deleteBooking(${b.id})" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded-lg text-xs font-bold border border-red-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : '-'}</td>
                                    </tr>`).join('')}
                            </tbody></table></div></div>`;
            $('contentArea').innerHTML = html;
        }

        // --- ACTIONS ---
        function openBookingModal() { $('bookingModal').classList.remove('hidden'); $('bkStart').min = new Date().toISOString().slice(0,16); renderRoomList(); }
        function closeModal() { $('bookingModal').classList.add('hidden'); }

        function renderRoomList() {
            $('roomList').innerHTML = allRooms.map(r => `
                <div class="border rounded-2xl p-4 flex justify-between items-center hover:border-indigo-500 hover:bg-indigo-50/20 transition cursor-pointer group" onclick="selectRoom(${r.id})">
                    <div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-gray-200 flex items-center justify-center text-white"><i class="fas fa-door-open text-gray-400"></i></div>
                        <div><h5 class="font-bold text-gray-800">${r.name}</h5><p class="text-xs text-gray-500">${r.capacity} ‡∏Ñ‡∏ô</p></div>
                    </div><button class="bg-white border text-indigo-600 px-4 py-2 rounded-xl text-xs font-bold group-hover:bg-indigo-600 group-hover:text-white transition">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                </div>`).join('');
        }

        async function selectRoom(roomId) {
            const topic = $('bkTopic').value;
            const startStr = $('bkStart').value;
            const equips = Array.from(document.querySelectorAll('.equip input:checked')).map(e => e.value).join(', ');

            if(!topic || !startStr) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°', 'error'); return; }

            try {
                const formData = new FormData();
                formData.append('userId', currentUser.id);
                formData.append('roomId', roomId);
                formData.append('start', startStr);
                formData.append('topic', topic);
                formData.append('equipment', equips);
                
                const res = await fetch(`${API_BASE_URL}/book`, { method: 'POST', body: formData });
                const data = await res.json();
                
                if(data.success) { showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); closeModal(); renderPage('home'); } 
                else { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message, 'error'); }
            } catch(e) { console.error(e); showToast('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
        }

        async function updateBooking(id, status) {
            const res = await fetch(`${API_BASE_URL}/admin/bookings/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
            if((await res.json()).success) {
                showToast(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                renderPage('approve');
            }
        }

        async function deleteBooking(id) {
            if(confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á?')) {
                const res = await fetch(`${API_BASE_URL}/bookings/${id}`, { method: 'DELETE' });
                if((await res.json()).success) {
                    showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    renderPage('history');
                }
            }
        }

        async function addNewRoom() {
            const name = prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:');
            if(!name) return;
            const capacity = prompt('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (‡∏Ñ‡∏ô):', 10);
            const res = await fetch(`${API_BASE_URL}/admin/rooms`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, capacity, facilities: '', status: 'active' }) });
            if((await res.json()).success) {
                showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                renderPage('rooms');
            }
        }
        
        async function deleteRoom(id) {
            if(confirm('‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) {
                const res = await fetch(`${API_BASE_URL}/admin/rooms/${id}`, { method: 'DELETE' });
                if((await res.json()).success) {
                    showToast('‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    renderPage('rooms');
                }
            }
        }

        async function deleteUser(id) {
            if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?')) {
                const res = await fetch(`${API_BASE_URL}/admin/users/${id}`, { method: 'DELETE' });
                if((await res.json()).success) {
                    showToast('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    renderPage('users');
                } else showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            }
        }

        function getStatusBadge(s) {
            if(s==='approved') return '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>';
            if(s==='pending') return '<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
            return '<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
        }
        function formatDateTime(str) { const d = new Date(str); return `${d.toLocaleDateString('th-TH', {day:'numeric',month:'short'})} ${d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}`; }
        function formatTime(str) { return new Date(str).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}); }
        
        function toggleSidebar(forceOpen = null) { 
            const sb = $('sidebar');
            const overlay = $('sidebarOverlay');
            
            if (forceOpen === false) {
                sb.classList.remove('open');
                overlay.classList.add('hidden');
            } else {
                sb.classList.toggle('open');
                overlay.classList.toggle('hidden');
            }
        }
    </script>
</body>
</html>
